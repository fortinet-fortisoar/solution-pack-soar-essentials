{
  "type": "workflow_collections",
  "data": [
    {
      "@context": "/api/3/contexts/WorkflowCollection",
      "@type": "WorkflowCollection",
      "name": "06 - IRP - Reporting",
      "description": null,
      "visible": true,
      "image": null,
      "id": 19,
      "createDate": 1649320375.517511,
      "modifyDate": 1649320375.517511,
      "deletedAt": null,
      "importedBy": [
        {
          "apiName": "sOARFramework",
          "name": "SOAR Framework",
          "version": "1.0.0"
        }
      ],
      "recordTags": [],
      "workflows": [
        {
          "@type": "Workflow",
          "triggerLimit": null,
          "name": "Export as CSV",
          "aliasName": null,
          "tag": null,
          "description": "Export all records of the given module with specified filters in the CSV format.",
          "isActive": true,
          "debug": false,
          "singleRecordExecution": false,
          "remoteExecutableFlag": false,
          "parameters": [],
          "synchronous": false,
          "lastModifyDate": 1649320376,
          "collection": "/api/3/workflow_collections/08c36467-9130-45a6-b4e7-391b8d87da7b",
          "versions": [],
          "triggerStep": "/api/3/workflow_steps/2be774af-784e-4882-9686-fc4600af2544",
          "steps": [
            {
              "@type": "WorkflowStep",
              "name": "Set Pages",
              "description": null,
              "arguments": {
                "pageRange": "{% set _list=[] %}{% if vars.pages >= 1%}{% for n in range(1, vars.pages + 1) %}{% set _temp=_list.append(n) %}{% endfor %}{% endif %}{{ _list }}"
              },
              "status": null,
              "top": "570",
              "left": "125",
              "stepType": "/api/3/workflow_step_types/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
              "uuid": "06debce4-a89d-4ac2-85d0-6864f8f200da"
            },
            {
              "@type": "WorkflowStep",
              "name": "Write Headers To File",
              "description": null,
              "arguments": {
                "config": "0fd89191-0436-4ba1-8eca-88771f17e159",
                "params": {
                  "python_function": "import csv\n\nrecordsToSave = {{vars.steps.Find_Records_Paginated.data[\"hydra:member\"]}} \ncolumns = recordsToSave[0].keys()\ncolumnsToAdd = [item for item in columns if item in {{ vars.incidentsFilter.__selectFields}}]\nwith open('/tmp/{{vars.resultsFileName}}.csv','w') as out_file:\n    csv_w = csv.writer(out_file)\n    csv_w.writerow(columnsToAdd)"
                },
                "version": "1.2.1",
                "connector": "code-snippet",
                "operation": "python_inline",
                "operationTitle": "Execute Python Code",
                "step_variables": []
              },
              "status": null,
              "top": "435",
              "left": "125",
              "stepType": "/api/3/workflow_step_types/1fdd14cc-d6b4-4335-a3af-ab49c8ed2fd8",
              "uuid": "09877abb-1ff9-41dd-bdce-af181174a5cc"
            },
            {
              "@type": "WorkflowStep",
              "name": "Start",
              "description": null,
              "arguments": {
                "route": "5c4b08ac-4ae7-4b4d-a8c5-ed15533d2df2",
                "title": "Export > All Records Data",
                "resources": [
                  "incidents"
                ],
                "inputVariables": [
                  {
                    "name": "emailID",
                    "type": "string",
                    "label": "Email ID",
                    "tooltip": "Please Enter Email ID for receiving report",
                    "dataType": "text",
                    "formType": "text",
                    "required": true,
                    "_expanded": true,
                    "defaultValue": "",
                    "useRecordFieldDefault": false
                  }
                ],
                "step_variables": {
                  "input": {
                    "params": {
                      "emailID": "{{vars.request.data[\"emailID\"]}}"
                    },
                    "records": "{{vars.input.records}}"
                  }
                },
                "_promptexpanded": true,
                "displayConditions": {
                  "incidents": {
                    "sort": [],
                    "limit": 30,
                    "logic": "AND",
                    "filters": []
                  }
                },
                "executeButtonText": "Execute",
                "noRecordExecution": true,
                "singleRecordExecution": false
              },
              "status": null,
              "top": "30",
              "left": "125",
              "stepType": "/api/3/workflow_step_types/f414d039-bb0d-4e59-9c39-a8f1e880b18a",
              "uuid": "2be774af-784e-4882-9686-fc4600af2544"
            },
            {
              "@type": "WorkflowStep",
              "name": "Configuration",
              "description": null,
              "arguments": {
                "pageSize": "250",
                "timezone": "Asia/Kolkata",
                "moduleName": "incidents",
                "toEmailAddress": "{{vars.input.params.emailID}}",
                "incidentsFilter": "{ \n   \"filters\":[ \n      { \n         \"field\":\"name\",\n         \"operator\":\"like\",\n         \"value\":\"%Suspicious%\"\n      },\n      { \n         \"field\":\"createDate\",\n         \"operator\":\"gt\",\n         \"value\":\"2018-01-31T16:22:55.297317+05:30\"\n      }\n   ],\n   \"logic\":\"AND\",\n  \"__selectFields\":[\"name\",\"category\",\"dueby\",\"phase\",\"status\",\"severity\",\"incidentLead\",\"createDate\",\"dateOfIncident\",\"id\",\"createUser\",\"modifyUser\"]\n}",
                "resultsFileName": "incidentExport-{{ arrow.utcnow().timestamp }}",
                "fromEmailAddress": "no-reply@cybersponse.com",
                "datetimeFieldsToConvert": "[\"createDate\", \"dueby\", \"dateOfIncident\"]"
              },
              "status": null,
              "top": "165",
              "left": "125",
              "stepType": "/api/3/workflow_step_types/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
              "uuid": "6c101d88-6806-4d66-8db2-fac9b1c66ef6"
            },
            {
              "@type": "WorkflowStep",
              "name": "Append Paginated Results",
              "description": null,
              "arguments": {
                "when": "{{vars.pages >= 1}}",
                "for_each": {
                  "item": "{{ vars.pageRange }}",
                  "condition": ""
                },
                "arguments": {
                  "queryURL": "/api/query/{{vars.moduleName}}?$limit={{vars.pageSize}}&$page={{vars.item}}",
                  "queryBody": "{{vars.incidentsFilter}}",
                  "fileToUpdate": "/tmp/{{vars.resultsFileName}}.csv",
                  "datetimeFieldsToConvert": "{{vars.datetimeFieldsToConvert}}"
                },
                "apply_async": false,
                "step_variables": [],
                "workflowReference": "/api/3/workflows/915f6b29-f9dd-4753-80dd-4d9a79d06ef4"
              },
              "status": null,
              "top": "700",
              "left": "120",
              "stepType": "/api/3/workflow_step_types/74932bdc-b8b6-4d24-88c4-1a4dfbc524f3",
              "uuid": "776315e9-1de1-411d-a5ff-bb2621ef8eaa"
            },
            {
              "@type": "WorkflowStep",
              "name": "Send Email",
              "description": null,
              "arguments": {
                "config": "88c3d39c-2fa9-4731-b00d-29815008f17c",
                "params": {
                  "cc": "",
                  "to": "{{vars.toEmailAddress}}",
                  "bcc": "",
                  "from": "{{vars.fromEmailAddress}}",
                  "type": "Manual Input",
                  "content": "Incident Export at {{ arrow.utcnow() }}",
                  "subject": "Incident Export Attached",
                  "iri_list": "",
                  "body_type": "Plain Text",
                  "file_name": "{{ vars.resultsFileName }}.zip",
                  "file_path": "{{ vars.resultsFileName }}.zip"
                },
                "version": "2.3.0",
                "from_str": "soc@cybersponse.com",
                "connector": "smtp",
                "operation": "send_email_new",
                "operationTitle": "Send Email",
                "step_variables": []
              },
              "status": null,
              "top": "975",
              "left": "125",
              "stepType": "/api/3/workflow_step_types/4c0019b2-055c-44d0-968c-678a0c2d762e",
              "uuid": "7786b073-c521-4898-86d9-602843fd5211"
            },
            {
              "@type": "WorkflowStep",
              "name": "Compress File",
              "description": null,
              "arguments": {
                "params": {
                  "filename": "{{vars.resultsFileName}}.csv",
                  "password": "",
                  "compress_level": 6,
                  "target_filename": "{{vars.resultsFileName}}.zip"
                },
                "version": "2.7.0",
                "connector": "cyops_utilities",
                "operation": "zip_and_protect_file",
                "operationTitle": "File: Zip",
                "step_variables": []
              },
              "status": null,
              "top": "840",
              "left": "125",
              "stepType": "/api/3/workflow_step_types/0109f35d-090b-4a2b-bd8a-94cbc3508562",
              "uuid": "d11c75da-8346-423e-95ad-0f2ed6ca697b"
            },
            {
              "@type": "WorkflowStep",
              "name": "Find Records Paginated",
              "description": null,
              "arguments": {
                "params": {
                  "iri": "/api/query/{{vars.moduleName}}?$limit={{vars.pageSize}}",
                  "body": "{{ vars.incidentsFilter }}",
                  "method": "POST"
                },
                "version": "3.2.1",
                "connector": "cyops_utilities",
                "operation": "make_cyops_request",
                "operationTitle": "CyOPs: Make CyOPs API Call",
                "step_variables": {
                  "pages": "{{(vars.result.data['hydra:totalItems']/vars.pageSize | int) | round(0, 'ceil') | int}}"
                }
              },
              "status": null,
              "top": "300",
              "left": "125",
              "stepType": "/api/3/workflow_step_types/0109f35d-090b-4a2b-bd8a-94cbc3508562",
              "uuid": "e32a3ca6-3bd1-42f4-8e6c-89158fa2ada6"
            }
          ],
          "routes": [
            {
              "@type": "WorkflowRoute",
              "name": "Compress File -> Send Email",
              "targetStep": "/api/3/workflow_steps/7786b073-c521-4898-86d9-602843fd5211",
              "sourceStep": "/api/3/workflow_steps/d11c75da-8346-423e-95ad-0f2ed6ca697b",
              "label": null,
              "isExecuted": false,
              "uuid": "1fcd9403-caf4-4bcc-9923-c143c65281ec"
            },
            {
              "@type": "WorkflowRoute",
              "name": "Write Results To File -> Set Pages",
              "targetStep": "/api/3/workflow_steps/06debce4-a89d-4ac2-85d0-6864f8f200da",
              "sourceStep": "/api/3/workflow_steps/09877abb-1ff9-41dd-bdce-af181174a5cc",
              "label": null,
              "isExecuted": false,
              "uuid": "4ab4fb4b-6d85-42e9-a124-eab3dda503b4"
            },
            {
              "@type": "WorkflowRoute",
              "name": "Set Pages -> Append next page results",
              "targetStep": "/api/3/workflow_steps/776315e9-1de1-411d-a5ff-bb2621ef8eaa",
              "sourceStep": "/api/3/workflow_steps/06debce4-a89d-4ac2-85d0-6864f8f200da",
              "label": null,
              "isExecuted": false,
              "uuid": "63861419-7ebf-40d6-b539-88742ed886b5"
            },
            {
              "@type": "WorkflowRoute",
              "name": "Start -> Set Incident Filter",
              "targetStep": "/api/3/workflow_steps/6c101d88-6806-4d66-8db2-fac9b1c66ef6",
              "sourceStep": "/api/3/workflow_steps/2be774af-784e-4882-9686-fc4600af2544",
              "label": null,
              "isExecuted": false,
              "uuid": "89e244ea-5e6c-4929-b6d7-b75801263770"
            },
            {
              "@type": "WorkflowRoute",
              "name": "Find Records Paginated -> Write Results To File",
              "targetStep": "/api/3/workflow_steps/09877abb-1ff9-41dd-bdce-af181174a5cc",
              "sourceStep": "/api/3/workflow_steps/e32a3ca6-3bd1-42f4-8e6c-89158fa2ada6",
              "label": null,
              "isExecuted": false,
              "uuid": "9952474b-d566-4594-afbb-7367e89c1f87"
            },
            {
              "@type": "WorkflowRoute",
              "name": "Append next page results -> Compress File",
              "targetStep": "/api/3/workflow_steps/d11c75da-8346-423e-95ad-0f2ed6ca697b",
              "sourceStep": "/api/3/workflow_steps/776315e9-1de1-411d-a5ff-bb2621ef8eaa",
              "label": null,
              "isExecuted": false,
              "uuid": "9c4eb78f-5a00-4917-9ac3-f9356fffab9a"
            },
            {
              "@type": "WorkflowRoute",
              "name": "Set Incident Filter -> Find Records Paginated",
              "targetStep": "/api/3/workflow_steps/e32a3ca6-3bd1-42f4-8e6c-89158fa2ada6",
              "sourceStep": "/api/3/workflow_steps/6c101d88-6806-4d66-8db2-fac9b1c66ef6",
              "label": null,
              "isExecuted": false,
              "uuid": "df114c5f-2e44-4bd2-ba19-c1701cf2f915"
            }
          ],
          "priority": null,
          "uuid": "ab2f3eb5-1625-4345-ad77-5246145af909",
          "id": 87,
          "createUser": "/api/3/people/3451141c-bac6-467c-8d72-85e0fab569ce",
          "createDate": 1649320375.518412,
          "modifyUser": "/api/3/people/3451141c-bac6-467c-8d72-85e0fab569ce",
          "modifyDate": 1649320375.518412,
          "owners": [],
          "isPrivate": false,
          "deletedAt": null,
          "importedBy": [
            {
              "apiName": "sOARFramework",
              "name": "SOAR Framework",
              "version": "1.0.0"
            }
          ],
          "recordTags": [
            "ManualAction"
          ]
        },
        {
          "@type": "Workflow",
          "triggerLimit": null,
          "name": "Get Paginated Records",
          "aliasName": null,
          "tag": null,
          "description": "Gets paginated records data and appends them in a .CSV file. This playbook is a reference playbook for 'Export as CSV'.",
          "isActive": true,
          "debug": false,
          "singleRecordExecution": false,
          "remoteExecutableFlag": false,
          "parameters": [
            "queryURL",
            "fileToUpdate",
            "queryBody",
            "datetimeFieldsToConvert",
            "timezone"
          ],
          "synchronous": false,
          "lastModifyDate": 1649320376,
          "collection": "/api/3/workflow_collections/08c36467-9130-45a6-b4e7-391b8d87da7b",
          "versions": [],
          "triggerStep": "/api/3/workflow_steps/bd320f7b-58f9-407b-844e-59420c58dc3f",
          "steps": [
            {
              "@type": "WorkflowStep",
              "name": "Run Query",
              "description": null,
              "arguments": {
                "params": {
                  "iri": "{{vars.input.params.queryURL}}",
                  "body": "{{vars.input.params.queryBody}}",
                  "method": "POST"
                },
                "version": "2.7.0",
                "connector": "cyops_utilities",
                "operation": "make_cyops_request",
                "operationTitle": "CyOPs: Make CyOPs API Call",
                "step_variables": []
              },
              "status": null,
              "top": "165",
              "left": "125",
              "stepType": "/api/3/workflow_step_types/0109f35d-090b-4a2b-bd8a-94cbc3508562",
              "uuid": "6244a24c-db42-4e1e-8d0a-ac349750f161"
            },
            {
              "@type": "WorkflowStep",
              "name": "Append to CSV File",
              "description": null,
              "arguments": {
                "config": "0fd89191-0436-4ba1-8eca-88771f17e159",
                "params": {
                  "python_function": "import csv\nimport arrow\n\nrecordsToSave = {{vars.steps.Run_Query.data['hydra:member']}}\ntimezone = \"{{vars.input.params.timezone}}\"\ncolumns = recordsToSave[0].keys()\nwith open('{{vars.fileToUpdate}}','a') as out_file:\n    csv_w = csv.writer(out_file)\n    for record in recordsToSave:\n        values = []\n        for key in columns:\n            if type(record[key]) is dict:\n               recordType = (record[key]).get('@type', None)\n               if recordType == 'Picklist':\n                   values.append(str(record[key]['itemValue']))\n               elif recordType == 'Person':\n                   values.append(str(record[key]['firstname'] + record[key]['lastname']))\n               elif recordType == 'Appliance':\n                   values.append(str(record[key]['name']))\n            elif key in {{ vars.input.params.datetimeFieldsToConvert}}:\n                values.append(arrow.get(record[key]).to(timezone).format('YYYY-MM-DD HH:mm:ss ZZ'))\n            elif key in {{ vars.input.params.queryBody['__selectFields']}}:\n                values.append(str(record[key]))\n        csv_w.writerow(values)"
                },
                "version": "1.2.5",
                "connector": "code-snippet",
                "operation": "python_inline",
                "operationTitle": "Execute Python Code",
                "step_variables": []
              },
              "status": null,
              "top": "300",
              "left": "125",
              "stepType": "/api/3/workflow_step_types/1fdd14cc-d6b4-4335-a3af-ab49c8ed2fd8",
              "uuid": "725387d7-8917-4ce6-b2a7-5d8884655aac"
            },
            {
              "@type": "WorkflowStep",
              "name": "Start",
              "description": null,
              "arguments": {
                "step_variables": {
                  "input": {
                    "params": {
                      "queryURL": "{{ vars.queryURL }}",
                      "timezone": "{{ vars.timezone }}",
                      "queryBody": "{{ vars.queryBody }}",
                      "queryToRun": "{{ vars.queryToRun }}",
                      "fileToUpdate": "{{ vars.fileToUpdate }}",
                      "selectFields": "{{ vars.selectFields }}",
                      "datetimeFieldsToConvert": "{{ vars.datetimeFieldsToConvert }}"
                    }
                  }
                }
              },
              "status": null,
              "top": "30",
              "left": "125",
              "stepType": "/api/3/workflow_step_types/b348f017-9a94-471f-87f8-ce88b6a7ad62",
              "uuid": "bd320f7b-58f9-407b-844e-59420c58dc3f"
            }
          ],
          "routes": [
            {
              "@type": "WorkflowRoute",
              "name": "Run Query -> Append to CSV File",
              "targetStep": "/api/3/workflow_steps/725387d7-8917-4ce6-b2a7-5d8884655aac",
              "sourceStep": "/api/3/workflow_steps/6244a24c-db42-4e1e-8d0a-ac349750f161",
              "label": null,
              "isExecuted": false,
              "uuid": "1dc914da-557a-4391-b141-73f2e4651891"
            },
            {
              "@type": "WorkflowRoute",
              "name": "Start -> Run Query",
              "targetStep": "/api/3/workflow_steps/6244a24c-db42-4e1e-8d0a-ac349750f161",
              "sourceStep": "/api/3/workflow_steps/bd320f7b-58f9-407b-844e-59420c58dc3f",
              "label": null,
              "isExecuted": false,
              "uuid": "9e60e92c-548f-4b17-893f-58bee89e6cdd"
            }
          ],
          "priority": null,
          "uuid": "915f6b29-f9dd-4753-80dd-4d9a79d06ef4",
          "id": 88,
          "createUser": "/api/3/people/3451141c-bac6-467c-8d72-85e0fab569ce",
          "createDate": 1649320375.518916,
          "modifyUser": "/api/3/people/3451141c-bac6-467c-8d72-85e0fab569ce",
          "modifyDate": 1649320375.518916,
          "owners": [],
          "isPrivate": false,
          "deletedAt": null,
          "importedBy": [
            {
              "apiName": "sOARFramework",
              "name": "SOAR Framework",
              "version": "1.0.0"
            }
          ],
          "recordTags": [
            "Subroutine",
            "Export as CSV"
          ]
        }
      ]
    }
  ],
  "exported_tags": [
    "ManualAction",
    "Subroutine",
    "Export as CSV"
  ]
}